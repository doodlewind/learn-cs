# 控制流

控制流指的是程序运行时，每条指令运行或求值的顺序。不同编程语言会提供的不同的流程控制指令，大致可以分为以下几种：

* 跳转到另一位置继续运行指令 - `goto`
* 若满足条件，则运行紧接的一段指令 - `if` / `else`
* 运行紧接的一段指令若干次，直到满足条件为止 - `while` / `for`
* 运行另一位置的一段指令，完成后回到原位置继续运行 - `function`

如此简单的几种控制流类型已经足够程序员使用 C 写出 Linux 复杂度的程序。并且这一套关键字体系影响非常深远，以至于今天的主流编程语言中几乎都多少存在它的影子。下面我们简要地展示 C 中与控制流相关的若干语言特性。由于 `goto` 存在争议，在目前的主流语言中也已经很少出现，因此我们着重讨论上面的四种情况中剩下的三种。

> 下文中涉及汇编的进阶介绍可以加深理解，在你需要了解 WASM 等字节码标准时或许也能对你有所帮助。但如果你的目标是复习 C 的语法，大可以略过它们 :)


## 分支

### 基础
[branch.c](./branch.c) 中这个形式的控制流可能是我们最熟悉的之一：

``` c
if (expression) {
  /* ... */
} else if (expression) {
  /* ... */
} else {
  /* ... */
}
```

我们会依次根据每个表达式的求值结果是否 `!= NULL`，判断是否走入相应的代码块。


### 进阶
如果你有兴趣观察 `gcc -S` 获得的汇编码，会发现一个 if 的判断逻辑背后不过是一条形如 `CMP` 的比较指令和 `JNE` 条件跳转（**J**ump if **N**ot **E**qual）指令而已。对于复杂的逻辑判断，我们只需要串联或嵌套多个 else if 子句即可。这样看来，这个语法兼顾了使用时的便利和实现上的简洁，是一个非常经典的语言特性。


## 循环

### 基础
[loop.c](./loop.c) 中的 for 循环也是非常经典的控制流。当然也别忘了 while 语句：

``` c
for (int i; i < 10; i++) {
  /* ... */
}

while (expression) {
  /* ... */
}
```

### 进阶
C 语言中 while 循环背后的原理较为简单：在循环体代码顶部放置一个 `JMP` 无条件跳转指令，它会始终跳转到循环体底部一对上文提及的 `CMP` 和 `JNE` 指令位置，由它们判断是否退出循环体：

``` nasm
       JMP LOOP   ; 首先跳到底部以开始循环
BEGIN: NOP        ; 空指令占位符
                  ; ...此处开始放置循环体中代码
                  ; ...
                  ; ...
                  ; ...执行完循环体内代码
LOOP:  CMP ...    ; 检查条件
       JNE BEGIN  ; 若不满足则跳转到 BEGIN 位置
```


而 for 循环所编译成的汇编代码执行流程和它接近，但多了循环的初始化过程和一个计数器临时变量，故而要退出 for 的检查实际上是针对这个计数器的。

别忘了 `break` 和 `continue` 关键字，它们可以允许有条件地跳出整个循环，或忽略循环体中的一部分代码。这是通过在循环体中添加更多的标号，从而更加灵活地 `JMP` 来实现的。


## 子程序

### 基础
子程序是一个概括性的术语，用来指代编程语言中可复用的一段代码块。C 和 JavaScript 中的函数就相当于子程序。子程序中可以调用其它子程序，从而实现代码的模块化。如果子程序调用了自己，我们将这种情况称为**递归**。在 [func.c](./func.c) 中有一个 C 语言函数递归调用的简单示例：

``` c
int fib(int n) {
  if (n == 0)
    return 0;
  else if (n == 1)
    return 1;
  else
    return (fib(n - 1) + fib(n - 2));
}
```

### 进阶
函数调用时发生了什么呢？这是个非常有意思的话题。函数作为编程语言中最基础的可复用元素，理解函数对于理解各种编程语言复用代码的原理会有很大的帮助。接下来我们将着重讨论这块内容。
